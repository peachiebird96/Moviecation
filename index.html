<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Moviecation</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <style>
    :root{--bg:#020617;--card:#0b1222;--line:#1f2937;--text:#e5e7eb;--muted:#9ca3af;--accent:#8b5cf6;--good:#22c55e;--bad:#ef4444;--r:14px;}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,sans-serif;background:radial-gradient(circle at top,#1f2937 0,#020617 55%) fixed;color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:rgba(2,6,23,.92);backdrop-filter:blur(12px);border-bottom:1px solid var(--line)}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);padding:16px;margin-bottom:20px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .grow{flex:1;min-width:200px}
    input,select,button{background:var(--bg);border:1px solid var(--line);color:inherit;padding:10px 14px;border-radius:10px;font-size:14px;outline:0}
    button{cursor:pointer;font-weight:600}.primary{background:var(--accent);border:0}
    .item{background:var(--card);border:1px solid var(--line);border-radius:var(--r);padding:12px;margin-bottom:12px;display:flex;gap:16px}
    .title{font-weight:700;font-size:1.1rem;margin-bottom:4px}
    .chips{display:flex;gap:6px;margin:8px 0;flex-wrap:wrap}
    .chip{font-size:11px;padding:2px 8px;border-radius:6px;background:var(--bg);border:1px solid var(--line);color:var(--muted);text-transform:uppercase}
    .pill{padding:4px 10px;background:var(--line);border-radius:20px;font-size:12px;font-weight:600}
    .btn-sml{padding:6px 10px; font-size:12px;}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row" style="justify-content:space-between">
        <h1>Moviecation</h1>
        <span id="statusPill" class="pill">loading...</span>
      </div>
      <div class="card">
        <div class="row">
          <input id="titleInput" class="grow" placeholder="Add a movie..." />
          <button id="addBtn" class="primary">Auto-Add</button>
        </div>
        <div class="row" style="margin-top:12px">
          <input id="q" class="grow" placeholder="Search titles..." />
          <select id="sf">
            <option value="all">All Status</option>
            <option value="to_watch">To Watch</option>
            <option value="watched">Watched</option>
          </select>
          <select id="vf"><option value="all">All Vibes</option></select>
          <select id="sv"><option value="all">All Services</option></select>
          <button id="clearBtn">Clear</button>
          <button id="fixPostersBtn" style="background:#f39c12">Fix Posters</button>
        </div>
      </div>
    </div>
  </header>
  <main class="wrap" id="listEl"></main>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-client@2";

    const supabase = createClient("https://vobpggwnttckqerfmsan.supabase.co", "sb_publishable_f_LdLwHeoEruDdwNtR77Yw_ceZw9e87");

    const $ = id => document.getElementById(id);
    const esc = s => s ? s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) : "";
    let state = { items: [] };

    async function loadState() {
      const { data } = await supabase.from("app_state").select("content").eq("id", 1).single();
      if (data) state = data.content;
      statusPill.textContent = "synced";
      updateFilterMenus(); // Build menus once on load
      render();
    }

    async function saveState() {
      statusPill.textContent = "saving...";
      await supabase.from("app_state").upsert({ id: 1, content: state });
      statusPill.textContent = "synced";
    }

    async function tmdb(path, params = {}) {
      const query = new URLSearchParams({ api_key: "69383688e1462002167d581559869680", ...params }).toString();
      const res = await fetch(`https://api.themoviedb.org/3${path}?${query}`);
      return res.json();
    }

    // NEW: Separated menu logic so it doesn't reset your selection
    function updateFilterMenus() {
      const vibes = new Set();
      const svcsList = new Set();
      state.items.forEach(it => {
        if (it.vibe) it.vibe.split(" / ").forEach(v => vibes.add(v));
        if (it.services) it.services.forEach(s => svcsList.add(s));
      });

      const curV = vf.value;
      const curS = sv.value;

      vf.innerHTML = '<option value="all">All Vibes</option>' + [...vibes].sort().map(v => `<option value="${v}">${v}</option>`).join("");
      sv.innerHTML = '<option value="all">All Services</option>' + [...svcsList].sort().map(s => `<option value="${s}">${s}</option>`).join("");
      
      vf.value = curV;
      sv.value = curS;
    }

    function render() {
      const query = q.value.toLowerCase();
      const sFilter = sf.value;
      const vFilter = vf.value;
      const svFilter = sv.value;

      const filtered = state.items.filter(it => {
        const matchesQ = it.title.toLowerCase().includes(query);
        const matchesS = sFilter === "all" || it.status === sFilter;
        const matchesV = vFilter === "all" || (it.vibe && it.vibe.includes(vFilter));
        const matchesSv = svFilter === "all" || (it.services && it.services.includes(svFilter));
        return matchesQ && matchesS && matchesV && matchesSv;
      });
      
      listEl.innerHTML = filtered.map(it => {
        const posterUrl = it.poster ? `https://image.tmdb.org/t/p/w185${it.poster}` : `https://via.placeholder.com/185x278?text=No+Poster`;
        const services = (it.services || []).map(s => `<span class="chip">${esc(s)}</span>`).join("") || '<span class="chip">Unknown</span>';
        const isWatched = it.status === 'watched';

        return `
          <div class="item" style="${isWatched ? 'opacity: 0.6; filter: grayscale(0.5);' : ''}">
            <img src="${posterUrl}" style="width:100px; border-radius:8px; aspect-ratio:2/3; object-fit:cover">
            <div style="flex:1">
              <div class="title">${esc(it.title)} ${it.year ? `<span style="color:var(--muted); font-weight:400">(${it.year})</span>` : ""}</div>
              <div class="chips">
                <span class="chip" style="color:var(--accent); border-color:var(--accent)">${esc(it.vibe || "No Vibe")}</span>
                <span class="chip">${it.status === 'watched' ? '✅ Watched' : '⏳ To Watch'}</span>
              </div>
              <div class="chips">${services}</div>
              <div style="margin-top:12px; display:flex; gap:8px;">
                <button class="btn-sml" style="border-color:var(--good)" data-status="${it.id}:${isWatched ? 'to_watch' : 'watched'}">
                  ${isWatched ? 'Unwatch' : 'Mark Watched'}
                </button>
                <button class="btn-sml" style="border-color:var(--bad)" data-del="${it.id}">Delete</button>
              </div>
            </div>
          </div>`;
      }).join("");

      listEl.querySelectorAll("[data-status]").forEach(b => {
        b.onclick = async () => {
          const [id, to] = b.getAttribute("data-status").split(":");
          const it = state.items.find(x => x.id === id);
          if (it) { it.status = to; await saveState(); render(); }
        };
      });

      listEl.querySelectorAll("[data-del]").forEach(b => {
        b.onclick = async () => {
          if(!confirm("Delete this movie?")) return;
          const id = b.getAttribute("data-del");
          state.items = state.items.filter(x => x.id !== id);
          await saveState(); 
          updateFilterMenus(); // Update menus because a vibe might be gone
          render();
        };
      });
    }

    addBtn.onclick = async () => {
      const title = titleInput.value.trim();
      if(!title) return;
      addBtn.disabled = true;
      const res = await tmdb("/search/movie", { query: title });
      if(res.results?.[0]) {
        const m = res.results[0];
        const d = await tmdb(`/movie/${m.id}`, { append_to_response: "watch/providers" });
        state.items.unshift({ 
          id: crypto.randomUUID(), 
          title: m.title, 
          year: m.release_date?.split("-")[0],
          poster: m.poster_path, 
          vibe: d.genres?.map(g => g.name).join(" / "),
          services: d["watch/providers"]?.results?.US?.flatrate?.map(p => p.provider_name) || [],
          status: 'to_watch', 
          tmdbId: m.id 
        });
        titleInput.value = "";
        await saveState(); 
        updateFilterMenus(); // New vibe might have been added
        render();
      }
      addBtn.disabled = false;
    };

    fixPostersBtn.onclick = async () => {
      fixPostersBtn.textContent = "Updating...";
      for (let it of state.items) {
        if (!it.poster && it.tmdbId) {
          const d = await tmdb(`/movie/${it.tmdbId}`);
          if (d.poster_path) it.poster = d.poster_path;
        }
      }
      await saveState(); render();
      fixPostersBtn.textContent = "Fix Posters";
    };

    q.oninput = render;
    sf.onchange = render;
    vf.onchange = render;
    sv.onchange = render;
    clearBtn.onclick = () => { q.value = ""; sf.value = "all"; vf.value = "all"; sv.value = "all"; render(); };

    loadState();
  </script>
</body>
</html>
