<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Moviecation</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <style>
    :root{--bg:#020617;--card:#0b1222;--line:#1f2937;--text:#e5e7eb;--muted:#9ca3af;--accent:#8b5cf6;--good:#22c55e;--bad:#ef4444;--r:14px;}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,sans-serif;background:radial-gradient(circle at top,#1f2937 0,#020617 55%) fixed;color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:rgba(2,6,23,.92);backdrop-filter:blur(12px);border-bottom:1px solid var(--line)}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);padding:16px;margin-bottom:20px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .grow{flex:1;min-width:200px}
    input,select,button{background:var(--bg);border:1px solid var(--line);color:inherit;padding:10px 14px;border-radius:10px;font-size:14px;outline:0}
    button{cursor:pointer;font-weight:600}.primary{background:var(--accent);border:0}
    .item{background:var(--card);border:1px solid var(--line);border-radius:var(--r);padding:12px;margin-bottom:12px;display:flex;gap:16px}
    .chip{font-size:11px;padding:2px 8px;border-radius:6px;background:var(--bg);border:1px solid var(--line);color:var(--muted)}
    .pill{padding:4px 10px;background:var(--line);border-radius:20px;font-size:12px;font-weight:600}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row" style="justify-content:space-between">
        <h1>Moviecation</h1>
        <span id="statusPill" class="pill">loading...</span>
      </div>
      <div class="card">
        <div class="row">
          <input id="titleInput" class="grow" placeholder="Movie Title..." />
          <button id="addBtn" class="primary">Add Movie</button>
          <input id="q" class="grow" placeholder="Search..." />
          <button id="fixPostersBtn" style="background:#f39c12">Fix Posters</button>
        </div>
      </div>
    </div>
  </header>
  <main class="wrap" id="listEl"></main>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-client@2";

    // 1. PUT YOUR ACTUAL KEYS HERE
    const supabase = createClient("https://fbiozabfithghkuldxgr.supabase.co", "sb_publishable_f_LdLwHeoEruDdwNtR77Yw_ceZw9e87");

    const $ = id => document.getElementById(id);
    const esc = s => s ? s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) : "";
    let state = { items: [] };

    // 2. DEFINE FUNCTIONS LOCALLY SO THEY CAN SEE EACH OTHER
    async function loadState() {
      const { data } = await supabase.from("app_state").select("content").eq("id", 1).single();
      if (data) state = data.content;
      statusPill.textContent = "synced";
    }

    async function saveState() {
      statusPill.textContent = "saving...";
      await supabase.from("app_state").upsert({ id: 1, content: state });
      statusPill.textContent = "synced";
    }

    async function tmdb(path, params = {}) {
      const query = new URLSearchParams({ api_key: "69383688e1462002167d581559869680", ...params }).toString();
      const res = await fetch(`https://api.themoviedb.org/3${path}?${query}`);
      return res.json();
    }

    function render() {
      const query = q.value.toLowerCase();
      const filtered = state.items.filter(it => it.title.toLowerCase().includes(query));
      
      listEl.innerHTML = filtered.map(it => `
        <div class="item">
          <img src="https://image.tmdb.org/t/p/w185${it.poster}" style="width:80px;border-radius:8px;aspect-ratio:2/3;object-fit:cover">
          <div style="flex:1">
            <div style="font-weight:700">${esc(it.title)}</div>
            <div class="chips"><span class="chip">${it.status}</span></div>
            <div style="margin-top:10px; display:flex; gap:8px;">
              <button style="border-color:#22c55e" data-status="${it.id}:watched">Watched</button>
              <button style="border-color:#ef4444" data-del="${it.id}">Delete</button>
            </div>
          </div>
        </div>`).join("");

      // Re-attach button clicks after rendering
      listEl.querySelectorAll("[data-status]").forEach(b => {
        b.onclick = async () => {
          const [id, to] = b.getAttribute("data-status").split(":");
          const it = state.items.find(x => x.id === id);
          if (it) { it.status = to; await saveState(); render(); }
        };
      });

      listEl.querySelectorAll("[data-del]").forEach(b => {
        b.onclick = async () => {
          const id = b.getAttribute("data-del");
          state.items = state.items.filter(x => x.id !== id);
          await saveState(); render();
        };
      });
    }

    // 3. EVENT HANDLERS
    addBtn.onclick = async () => {
      const title = titleInput.value.trim();
      if(!title) return;
      addBtn.disabled = true;
      const res = await tmdb("/search/movie", { query: title });
      if(res.results?.[0]) {
        const m = res.results[0];
        state.items.unshift({ id: crypto.randomUUID(), title: m.title, poster: m.poster_path, status: 'to_watch', tmdbId: m.id });
        titleInput.value = "";
        await saveState(); render();
      }
      addBtn.disabled = false;
    };

    fixPostersBtn.onclick = async () => {
      fixPostersBtn.textContent = "Updating...";
      for (let it of state.items) {
        if (!it.poster && it.tmdbId) {
          const d = await tmdb(`/movie/${it.tmdbId}`);
          if (d.poster_path) it.poster = d.poster_path;
        }
      }
      await saveState(); render();
      fixPostersBtn.textContent = "Fix Posters";
    };

    q.oninput = render;

    // 4. THE STARTING ENGINE
    (async () => {
      await loadState();
      render();
    })();
  </script>
</body>
</html>
